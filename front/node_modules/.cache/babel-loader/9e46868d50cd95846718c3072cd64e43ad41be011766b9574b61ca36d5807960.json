{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2024 Google LLC.\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WindowRealm = void 0;\nconst protocol_js_1 = require(\"../../../protocol/protocol.js\");\nconst Realm_js_1 = require(\"./Realm.js\");\nconst SharedId_js_1 = require(\"./SharedId.js\");\nclass WindowRealm extends Realm_js_1.Realm {\n  #browsingContextId;\n  #browsingContextStorage;\n  #sharedIdWithFrame;\n  sandbox;\n  constructor(browsingContextId, browsingContextStorage, cdpClient, eventManager, executionContextId, logger, origin, realmId, realmStorage, sandbox, sharedIdWithFrame) {\n    super(cdpClient, eventManager, executionContextId, logger, origin, realmId, realmStorage);\n    this.#browsingContextId = browsingContextId;\n    this.#browsingContextStorage = browsingContextStorage;\n    this.#sharedIdWithFrame = sharedIdWithFrame;\n    this.sandbox = sandbox;\n    this.initialize();\n  }\n  #getBrowsingContextId(navigableId) {\n    const maybeBrowsingContext = this.#browsingContextStorage.getAllContexts().find(context => context.navigableId === navigableId);\n    return maybeBrowsingContext?.id ?? 'UNKNOWN';\n  }\n  get browsingContext() {\n    return this.#browsingContextStorage.getContext(this.#browsingContextId);\n  }\n  get associatedBrowsingContexts() {\n    return [this.browsingContext];\n  }\n  get realmType() {\n    return 'window';\n  }\n  get realmInfo() {\n    return {\n      ...this.baseInfo,\n      type: this.realmType,\n      context: this.#browsingContextId,\n      sandbox: this.sandbox\n    };\n  }\n  get source() {\n    return {\n      realm: this.realmId,\n      context: this.browsingContext.id\n    };\n  }\n  serializeForBiDi(deepSerializedValue, internalIdMap) {\n    const bidiValue = deepSerializedValue.value;\n    if (deepSerializedValue.type === 'node') {\n      if (Object.hasOwn(bidiValue, 'backendNodeId')) {\n        let navigableId = this.browsingContext.navigableId ?? 'UNKNOWN';\n        if (Object.hasOwn(bidiValue, 'loaderId')) {\n          // `loaderId` should be always there after ~2024-03-05, when\n          // https://crrev.com/c/5116240 reaches stable.\n          // TODO: remove the check after the date.\n          navigableId = bidiValue.loaderId;\n          delete bidiValue['loaderId'];\n        }\n        deepSerializedValue.sharedId = (0, SharedId_js_1.getSharedId)(this.#getBrowsingContextId(navigableId), navigableId, bidiValue.backendNodeId, this.#sharedIdWithFrame);\n        delete bidiValue['backendNodeId'];\n      }\n      if (Object.hasOwn(bidiValue, 'children')) {\n        for (const i in bidiValue.children) {\n          bidiValue.children[i] = this.serializeForBiDi(bidiValue.children[i], internalIdMap);\n        }\n      }\n      if (Object.hasOwn(bidiValue, 'shadowRoot') && bidiValue.shadowRoot !== null) {\n        bidiValue.shadowRoot = this.serializeForBiDi(bidiValue.shadowRoot, internalIdMap);\n      }\n      // `namespaceURI` can be is either `null` or non-empty string.\n      if (bidiValue.namespaceURI === '') {\n        bidiValue.namespaceURI = null;\n      }\n    }\n    return super.serializeForBiDi(deepSerializedValue, internalIdMap);\n  }\n  async deserializeForCdp(localValue) {\n    if ('sharedId' in localValue && localValue.sharedId) {\n      const parsedSharedId = (0, SharedId_js_1.parseSharedId)(localValue.sharedId);\n      if (parsedSharedId === null) {\n        throw new protocol_js_1.NoSuchNodeException(`SharedId \"${localValue.sharedId}\" was not found.`);\n      }\n      const {\n        documentId,\n        backendNodeId\n      } = parsedSharedId;\n      // TODO: add proper validation if the element is accessible from the current realm.\n      if (this.browsingContext.navigableId !== documentId) {\n        throw new protocol_js_1.NoSuchNodeException(`SharedId \"${localValue.sharedId}\" belongs to different document. Current document is ${this.browsingContext.navigableId}.`);\n      }\n      try {\n        const {\n          object\n        } = await this.cdpClient.sendCommand('DOM.resolveNode', {\n          backendNodeId,\n          executionContextId: this.executionContextId\n        });\n        // TODO(#375): Release `obj.object.objectId` after using.\n        return {\n          objectId: object.objectId\n        };\n      } catch (error) {\n        // Heuristic to detect \"no such node\" exception. Based on the  specific\n        // CDP implementation.\n        if (error.code === -32000 /* CdpErrorConstants.GENERIC_ERROR */ && error.message === 'No node with given id found') {\n          throw new protocol_js_1.NoSuchNodeException(`SharedId \"${localValue.sharedId}\" was not found.`);\n        }\n        throw new protocol_js_1.UnknownErrorException(error.message, error.stack);\n      }\n    }\n    return await super.deserializeForCdp(localValue);\n  }\n  async evaluate(expression, awaitPromise, resultOwnership, serializationOptions, userActivation) {\n    await this.#browsingContextStorage.getContext(this.#browsingContextId).targetUnblockedOrThrow();\n    return await super.evaluate(expression, awaitPromise, resultOwnership, serializationOptions, userActivation);\n  }\n  async callFunction(functionDeclaration, thisLocalValue, argumentsLocalValues, awaitPromise, resultOwnership, serializationOptions, userActivation) {\n    await this.#browsingContextStorage.getContext(this.#browsingContextId).targetUnblockedOrThrow();\n    return await super.callFunction(functionDeclaration, thisLocalValue, argumentsLocalValues, awaitPromise, resultOwnership, serializationOptions, userActivation);\n  }\n}\nexports.WindowRealm = WindowRealm;","map":{"version":3,"names":["protocol_js_1","require","Realm_js_1","SharedId_js_1","WindowRealm","Realm","browsingContextId","browsingContextStorage","sharedIdWithFrame","sandbox","constructor","cdpClient","eventManager","executionContextId","logger","origin","realmId","realmStorage","initialize","getBrowsingContextId","#getBrowsingContextId","navigableId","maybeBrowsingContext","getAllContexts","find","context","id","browsingContext","getContext","associatedBrowsingContexts","realmType","realmInfo","baseInfo","type","source","realm","serializeForBiDi","deepSerializedValue","internalIdMap","bidiValue","value","Object","hasOwn","loaderId","sharedId","getSharedId","backendNodeId","i","children","shadowRoot","namespaceURI","deserializeForCdp","localValue","parsedSharedId","parseSharedId","NoSuchNodeException","documentId","object","sendCommand","objectId","error","code","message","UnknownErrorException","stack","evaluate","expression","awaitPromise","resultOwnership","serializationOptions","userActivation","targetUnblockedOrThrow","callFunction","functionDeclaration","thisLocalValue","argumentsLocalValues","exports"],"sources":["../../../../../src/bidiMapper/domains/script/WindowRealm.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}