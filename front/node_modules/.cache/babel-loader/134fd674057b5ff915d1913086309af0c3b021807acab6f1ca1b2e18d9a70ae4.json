{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2022 Google LLC.\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.serializeOrigin = exports.BrowsingContextImpl = void 0;\nconst chromium_bidi_js_1 = require(\"../../../protocol/chromium-bidi.js\");\nconst protocol_js_1 = require(\"../../../protocol/protocol.js\");\nconst assert_js_1 = require(\"../../../utils/assert.js\");\nconst Deferred_js_1 = require(\"../../../utils/Deferred.js\");\nconst log_js_1 = require(\"../../../utils/log.js\");\nconst unitConversions_js_1 = require(\"../../../utils/unitConversions.js\");\nconst WindowRealm_js_1 = require(\"../script/WindowRealm.js\");\nclass BrowsingContextImpl {\n  static LOGGER_PREFIX = `${log_js_1.LogType.debug}:browsingContext`;\n  /** The ID of this browsing context. */\n  #id;\n  userContext;\n  /**\n   * The ID of the parent browsing context.\n   * If null, this is a top-level context.\n   */\n  #parentId;\n  /** Direct children browsing contexts. */\n  #children = new Set();\n  #browsingContextStorage;\n  #lifecycle = {\n    DOMContentLoaded: new Deferred_js_1.Deferred(),\n    load: new Deferred_js_1.Deferred()\n  };\n  #navigation = {\n    withinDocument: new Deferred_js_1.Deferred()\n  };\n  #url = 'about:blank';\n  #eventManager;\n  #realmStorage;\n  #loaderId;\n  #cdpTarget;\n  #maybeDefaultRealm;\n  #sharedIdWithFrame;\n  #logger;\n  constructor(cdpTarget, realmStorage, id, parentId, userContext, eventManager, browsingContextStorage, sharedIdWithFrame, logger) {\n    this.#cdpTarget = cdpTarget;\n    this.#realmStorage = realmStorage;\n    this.#id = id;\n    this.#parentId = parentId;\n    this.userContext = userContext;\n    this.#eventManager = eventManager;\n    this.#browsingContextStorage = browsingContextStorage;\n    this.#sharedIdWithFrame = sharedIdWithFrame;\n    this.#logger = logger;\n  }\n  static create(cdpTarget, realmStorage, id, parentId, userContext, eventManager, browsingContextStorage, sharedIdWithFrame, logger) {\n    const context = new BrowsingContextImpl(cdpTarget, realmStorage, id, parentId, userContext, eventManager, browsingContextStorage, sharedIdWithFrame, logger);\n    context.#initListeners();\n    browsingContextStorage.addContext(context);\n    if (!context.isTopLevelContext()) {\n      context.parent.addChild(context.id);\n    }\n    eventManager.registerEvent({\n      type: 'event',\n      method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.ContextCreated,\n      params: context.serializeToBidiValue()\n    }, context.id);\n    return context;\n  }\n  static getTimestamp() {\n    // `timestamp` from the event is MonotonicTime, not real time, so\n    // the best Mapper can do is to set the timestamp to the epoch time\n    // of the event arrived.\n    // https://chromedevtools.github.io/devtools-protocol/tot/Network/#type-MonotonicTime\n    return new Date().getTime();\n  }\n  /**\n   * @see https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\n   */\n  get navigableId() {\n    return this.#loaderId;\n  }\n  dispose() {\n    this.#deleteAllChildren();\n    this.#realmStorage.deleteRealms({\n      browsingContextId: this.id\n    });\n    // Remove context from the parent.\n    if (!this.isTopLevelContext()) {\n      this.parent.#children.delete(this.id);\n    }\n    // Fail all ongoing navigations.\n    this.#failLifecycleIfNotFinished();\n    this.#eventManager.registerEvent({\n      type: 'event',\n      method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.ContextDestroyed,\n      params: this.serializeToBidiValue()\n    }, this.id);\n    this.#browsingContextStorage.deleteContextById(this.id);\n  }\n  /** Returns the ID of this context. */\n  get id() {\n    return this.#id;\n  }\n  /** Returns the parent context ID. */\n  get parentId() {\n    return this.#parentId;\n  }\n  /** Returns the parent context. */\n  get parent() {\n    if (this.parentId === null) {\n      return null;\n    }\n    return this.#browsingContextStorage.getContext(this.parentId);\n  }\n  /** Returns all direct children contexts. */\n  get directChildren() {\n    return [...this.#children].map(id => this.#browsingContextStorage.getContext(id));\n  }\n  /** Returns all children contexts, flattened. */\n  get allChildren() {\n    const children = this.directChildren;\n    return children.concat(...children.map(child => child.allChildren));\n  }\n  /**\n   * Returns true if this is a top-level context.\n   * This is the case whenever the parent context ID is null.\n   */\n  isTopLevelContext() {\n    return this.#parentId === null;\n  }\n  get top() {\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    let topContext = this;\n    let parent = topContext.parent;\n    while (parent) {\n      topContext = parent;\n      parent = topContext.parent;\n    }\n    return topContext;\n  }\n  addChild(childId) {\n    this.#children.add(childId);\n  }\n  #deleteAllChildren() {\n    this.directChildren.map(child => child.dispose());\n  }\n  get #defaultRealm() {\n    (0, assert_js_1.assert)(this.#maybeDefaultRealm, `No default realm for browsing context ${this.#id}`);\n    return this.#maybeDefaultRealm;\n  }\n  get cdpTarget() {\n    return this.#cdpTarget;\n  }\n  updateCdpTarget(cdpTarget) {\n    this.#cdpTarget = cdpTarget;\n    this.#initListeners();\n  }\n  get url() {\n    return this.#url;\n  }\n  async lifecycleLoaded() {\n    await this.#lifecycle.load;\n  }\n  async targetUnblockedOrThrow() {\n    const result = await this.#cdpTarget.unblocked;\n    if (result.kind === 'error') {\n      throw result.error;\n    }\n  }\n  async getOrCreateSandbox(sandbox) {\n    if (sandbox === undefined || sandbox === '') {\n      return this.#defaultRealm;\n    }\n    let maybeSandboxes = this.#realmStorage.findRealms({\n      browsingContextId: this.id,\n      sandbox\n    });\n    if (maybeSandboxes.length === 0) {\n      await this.#cdpTarget.cdpClient.sendCommand('Page.createIsolatedWorld', {\n        frameId: this.id,\n        worldName: sandbox\n      });\n      // `Runtime.executionContextCreated` should be emitted by the time the\n      // previous command is done.\n      maybeSandboxes = this.#realmStorage.findRealms({\n        browsingContextId: this.id,\n        sandbox\n      });\n      (0, assert_js_1.assert)(maybeSandboxes.length !== 0);\n    }\n    // It's possible for more than one sandbox to be created due to provisional\n    // frames. In this case, it's always the first one (i.e. the oldest one)\n    // that is more relevant since the user may have set that one up already\n    // through evaluation.\n    return maybeSandboxes[0];\n  }\n  serializeToBidiValue(maxDepth = 0, addParentField = true) {\n    return {\n      context: this.#id,\n      url: this.url,\n      userContext: this.userContext,\n      children: maxDepth > 0 ? this.directChildren.map(c => c.serializeToBidiValue(maxDepth - 1, false)) : null,\n      ...(addParentField ? {\n        parent: this.#parentId\n      } : {})\n    };\n  }\n  onTargetInfoChanged(params) {\n    this.#url = params.targetInfo.url;\n  }\n  #initListeners() {\n    this.#cdpTarget.cdpClient.on('Page.frameNavigated', params => {\n      if (this.id !== params.frame.id) {\n        return;\n      }\n      this.#url = params.frame.url + (params.frame.urlFragment ?? '');\n      // At the point the page is initialized, all the nested iframes from the\n      // previous page are detached and realms are destroyed.\n      // Remove children from context.\n      this.#deleteAllChildren();\n    });\n    this.#cdpTarget.cdpClient.on('Page.navigatedWithinDocument', params => {\n      if (this.id !== params.frameId) {\n        return;\n      }\n      const timestamp = BrowsingContextImpl.getTimestamp();\n      this.#url = params.url;\n      this.#navigation.withinDocument.resolve(params);\n      this.#eventManager.registerEvent({\n        type: 'event',\n        method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.FragmentNavigated,\n        params: {\n          context: this.id,\n          navigation: null,\n          timestamp,\n          url: this.#url\n        }\n      }, this.id);\n    });\n    this.#cdpTarget.cdpClient.on('Page.frameStartedLoading', params => {\n      if (this.id !== params.frameId) {\n        return;\n      }\n      this.#eventManager.registerEvent({\n        type: 'event',\n        method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.NavigationStarted,\n        params: {\n          context: this.id,\n          navigation: null,\n          timestamp: BrowsingContextImpl.getTimestamp(),\n          url: ''\n        }\n      }, this.id);\n    });\n    this.#cdpTarget.cdpClient.on('Page.lifecycleEvent', params => {\n      if (this.id !== params.frameId) {\n        return;\n      }\n      if (params.name === 'init') {\n        this.#documentChanged(params.loaderId);\n        return;\n      }\n      if (params.name === 'commit') {\n        this.#loaderId = params.loaderId;\n        return;\n      }\n      // Ignore event from not current navigation.\n      if (params.loaderId !== this.#loaderId) {\n        return;\n      }\n      const timestamp = BrowsingContextImpl.getTimestamp();\n      switch (params.name) {\n        case 'DOMContentLoaded':\n          this.#eventManager.registerEvent({\n            type: 'event',\n            method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.DomContentLoaded,\n            params: {\n              context: this.id,\n              navigation: this.#loaderId ?? null,\n              timestamp,\n              url: this.#url\n            }\n          }, this.id);\n          this.#lifecycle.DOMContentLoaded.resolve(params);\n          break;\n        case 'load':\n          this.#eventManager.registerEvent({\n            type: 'event',\n            method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.Load,\n            params: {\n              context: this.id,\n              navigation: this.#loaderId ?? null,\n              timestamp,\n              url: this.#url\n            }\n          }, this.id);\n          this.#lifecycle.load.resolve(params);\n          break;\n      }\n    });\n    this.#cdpTarget.cdpClient.on('Runtime.executionContextCreated', params => {\n      const {\n        auxData,\n        name,\n        uniqueId,\n        id\n      } = params.context;\n      if (!auxData || auxData.frameId !== this.id) {\n        return;\n      }\n      let origin;\n      let sandbox;\n      // Only these execution contexts are supported for now.\n      switch (auxData.type) {\n        case 'isolated':\n          sandbox = name;\n          // Sandbox should have the same origin as the context itself, but in CDP\n          // it has an empty one.\n          origin = this.#defaultRealm.origin;\n          break;\n        case 'default':\n          origin = serializeOrigin(params.context.origin);\n          break;\n        default:\n          return;\n      }\n      const realm = new WindowRealm_js_1.WindowRealm(this.id, this.#browsingContextStorage, this.#cdpTarget.cdpClient, this.#eventManager, id, this.#logger, origin, uniqueId, this.#realmStorage, sandbox, this.#sharedIdWithFrame);\n      if (auxData.isDefault) {\n        this.#maybeDefaultRealm = realm;\n        // Initialize ChannelProxy listeners for all the channels of all the\n        // preload scripts related to this BrowsingContext.\n        // TODO: extend for not default realms by the sandbox name.\n        void Promise.all(this.#cdpTarget.getChannels().map(channel => channel.startListenerFromWindow(realm, this.#eventManager)));\n      }\n    });\n    this.#cdpTarget.cdpClient.on('Runtime.executionContextDestroyed', params => {\n      this.#realmStorage.deleteRealms({\n        cdpSessionId: this.#cdpTarget.cdpSessionId,\n        executionContextId: params.executionContextId\n      });\n    });\n    this.#cdpTarget.cdpClient.on('Runtime.executionContextsCleared', () => {\n      this.#realmStorage.deleteRealms({\n        cdpSessionId: this.#cdpTarget.cdpSessionId\n      });\n    });\n    this.#cdpTarget.cdpClient.on('Page.javascriptDialogClosed', params => {\n      const accepted = params.result;\n      this.#eventManager.registerEvent({\n        type: 'event',\n        method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.UserPromptClosed,\n        params: {\n          context: this.id,\n          accepted,\n          userText: accepted && params.userInput ? params.userInput : undefined\n        }\n      }, this.id);\n    });\n    this.#cdpTarget.cdpClient.on('Page.javascriptDialogOpening', params => {\n      this.#eventManager.registerEvent({\n        type: 'event',\n        method: protocol_js_1.ChromiumBidi.BrowsingContext.EventNames.UserPromptOpened,\n        params: {\n          context: this.id,\n          type: params.type,\n          message: params.message,\n          // Don't set the value if empty string\n          defaultValue: params.defaultPrompt || undefined\n        }\n      }, this.id);\n    });\n  }\n  #documentChanged(loaderId) {\n    // Same document navigation.\n    if (loaderId === undefined || this.#loaderId === loaderId) {\n      if (this.#navigation.withinDocument.isFinished) {\n        this.#navigation.withinDocument = new Deferred_js_1.Deferred();\n      } else {\n        this.#logger?.(BrowsingContextImpl.LOGGER_PREFIX, 'Document changed (navigatedWithinDocument)');\n      }\n      return;\n    }\n    this.#resetLifecycleIfFinished();\n    this.#loaderId = loaderId;\n  }\n  #resetLifecycleIfFinished() {\n    if (this.#lifecycle.DOMContentLoaded.isFinished) {\n      this.#lifecycle.DOMContentLoaded = new Deferred_js_1.Deferred();\n    } else {\n      this.#logger?.(BrowsingContextImpl.LOGGER_PREFIX, 'Document changed (DOMContentLoaded)');\n    }\n    if (this.#lifecycle.load.isFinished) {\n      this.#lifecycle.load = new Deferred_js_1.Deferred();\n    } else {\n      this.#logger?.(BrowsingContextImpl.LOGGER_PREFIX, 'Document changed (load)');\n    }\n  }\n  #failLifecycleIfNotFinished() {\n    if (!this.#lifecycle.DOMContentLoaded.isFinished) {\n      this.#lifecycle.DOMContentLoaded.reject(new protocol_js_1.UnknownErrorException('navigation canceled'));\n    }\n    if (!this.#lifecycle.load.isFinished) {\n      this.#lifecycle.load.reject(new protocol_js_1.UnknownErrorException('navigation canceled'));\n    }\n  }\n  async navigate(url, wait) {\n    try {\n      new URL(url);\n    } catch {\n      throw new protocol_js_1.InvalidArgumentException(`Invalid URL: ${url}`);\n    }\n    await this.targetUnblockedOrThrow();\n    // TODO: handle loading errors.\n    const cdpNavigateResult = await this.#cdpTarget.cdpClient.sendCommand('Page.navigate', {\n      url,\n      frameId: this.id\n    });\n    if (cdpNavigateResult.errorText) {\n      throw new protocol_js_1.UnknownErrorException(cdpNavigateResult.errorText);\n    }\n    this.#documentChanged(cdpNavigateResult.loaderId);\n    switch (wait) {\n      case \"none\" /* BrowsingContext.ReadinessState.None */:\n        break;\n      case \"interactive\" /* BrowsingContext.ReadinessState.Interactive */:\n        // No `loaderId` means same-document navigation.\n        if (cdpNavigateResult.loaderId === undefined) {\n          await this.#navigation.withinDocument;\n        } else {\n          await this.#lifecycle.DOMContentLoaded;\n        }\n        break;\n      case \"complete\" /* BrowsingContext.ReadinessState.Complete */:\n        // No `loaderId` means same-document navigation.\n        if (cdpNavigateResult.loaderId === undefined) {\n          await this.#navigation.withinDocument;\n        } else {\n          await this.#lifecycle.load;\n        }\n        break;\n    }\n    return {\n      navigation: cdpNavigateResult.loaderId ?? null,\n      // Url can change due to redirect get the latest one.\n      url: wait === \"none\" /* BrowsingContext.ReadinessState.None */ ? url : this.#url\n    };\n  }\n  async reload(ignoreCache, wait) {\n    await this.targetUnblockedOrThrow();\n    this.#resetLifecycleIfFinished();\n    await this.#cdpTarget.cdpClient.sendCommand('Page.reload', {\n      ignoreCache\n    });\n    switch (wait) {\n      case \"none\" /* BrowsingContext.ReadinessState.None */:\n        break;\n      case \"interactive\" /* BrowsingContext.ReadinessState.Interactive */:\n        await this.#lifecycle.DOMContentLoaded;\n        break;\n      case \"complete\" /* BrowsingContext.ReadinessState.Complete */:\n        await this.#lifecycle.load;\n        break;\n    }\n    return {\n      navigation: wait === \"none\" /* BrowsingContext.ReadinessState.None */ ? null : this.navigableId ?? null,\n      url: this.url\n    };\n  }\n  async setViewport(viewport, devicePixelRatio) {\n    if (viewport === null && devicePixelRatio === null) {\n      await this.#cdpTarget.cdpClient.sendCommand('Emulation.clearDeviceMetricsOverride');\n    } else {\n      try {\n        await this.#cdpTarget.cdpClient.sendCommand('Emulation.setDeviceMetricsOverride', {\n          width: viewport ? viewport.width : 0,\n          height: viewport ? viewport.height : 0,\n          deviceScaleFactor: devicePixelRatio ? devicePixelRatio : 0,\n          mobile: false,\n          dontSetVisibleSize: true\n        });\n      } catch (err) {\n        if (err.message.startsWith(\n        // https://crsrc.org/c/content/browser/devtools/protocol/emulation_handler.cc;l=257;drc=2f6eee84cf98d4227e7c41718dd71b82f26d90ff\n        'Width and height values must be positive')) {\n          throw new protocol_js_1.UnsupportedOperationException('Provided viewport dimensions are not supported');\n        }\n        throw err;\n      }\n    }\n  }\n  async handleUserPrompt(params) {\n    await this.#cdpTarget.cdpClient.sendCommand('Page.handleJavaScriptDialog', {\n      accept: params.accept ?? true,\n      promptText: params.userText\n    });\n  }\n  async activate() {\n    await this.#cdpTarget.cdpClient.sendCommand('Page.bringToFront');\n  }\n  async captureScreenshot(params) {\n    if (!this.isTopLevelContext()) {\n      throw new protocol_js_1.UnsupportedOperationException(`Non-top-level 'context' (${params.context}) is currently not supported`);\n    }\n    const formatParameters = getImageFormatParameters(params);\n    // XXX: Focus the original tab after the screenshot is taken.\n    // This is needed because the screenshot gets blocked until the active tab gets focus.\n    await this.#cdpTarget.cdpClient.sendCommand('Page.bringToFront');\n    let captureBeyondViewport = false;\n    let script;\n    params.origin ??= 'viewport';\n    switch (params.origin) {\n      case 'document':\n        {\n          script = String(() => {\n            const element = document.documentElement;\n            return {\n              x: 0,\n              y: 0,\n              width: element.scrollWidth,\n              height: element.scrollHeight\n            };\n          });\n          captureBeyondViewport = true;\n          break;\n        }\n      case 'viewport':\n        {\n          script = String(() => {\n            const viewport = window.visualViewport;\n            return {\n              x: viewport.pageLeft,\n              y: viewport.pageTop,\n              width: viewport.width,\n              height: viewport.height\n            };\n          });\n          break;\n        }\n    }\n    const realm = await this.getOrCreateSandbox(undefined);\n    const originResult = await realm.callFunction(script, {\n      type: 'undefined'\n    }, [], false, \"none\" /* Script.ResultOwnership.None */, {}, false);\n    (0, assert_js_1.assert)(originResult.type === 'success');\n    const origin = deserializeDOMRect(originResult.result);\n    (0, assert_js_1.assert)(origin);\n    const rect = params.clip ? getIntersectionRect(await this.#parseRect(params.clip), origin) : origin;\n    if (rect.width === 0 || rect.height === 0) {\n      throw new protocol_js_1.UnableToCaptureScreenException(`Unable to capture screenshot with zero dimensions: width=${rect.width}, height=${rect.height}`);\n    }\n    return await this.#cdpTarget.cdpClient.sendCommand('Page.captureScreenshot', {\n      clip: {\n        ...rect,\n        scale: 1.0\n      },\n      ...formatParameters,\n      captureBeyondViewport\n    });\n  }\n  async print(params) {\n    const cdpParams = {};\n    if (params.background !== undefined) {\n      cdpParams.printBackground = params.background;\n    }\n    if (params.margin?.bottom !== undefined) {\n      cdpParams.marginBottom = (0, unitConversions_js_1.inchesFromCm)(params.margin.bottom);\n    }\n    if (params.margin?.left !== undefined) {\n      cdpParams.marginLeft = (0, unitConversions_js_1.inchesFromCm)(params.margin.left);\n    }\n    if (params.margin?.right !== undefined) {\n      cdpParams.marginRight = (0, unitConversions_js_1.inchesFromCm)(params.margin.right);\n    }\n    if (params.margin?.top !== undefined) {\n      cdpParams.marginTop = (0, unitConversions_js_1.inchesFromCm)(params.margin.top);\n    }\n    if (params.orientation !== undefined) {\n      cdpParams.landscape = params.orientation === 'landscape';\n    }\n    if (params.page?.height !== undefined) {\n      cdpParams.paperHeight = (0, unitConversions_js_1.inchesFromCm)(params.page.height);\n    }\n    if (params.page?.width !== undefined) {\n      cdpParams.paperWidth = (0, unitConversions_js_1.inchesFromCm)(params.page.width);\n    }\n    if (params.pageRanges !== undefined) {\n      for (const range of params.pageRanges) {\n        if (typeof range === 'number') {\n          continue;\n        }\n        const rangeParts = range.split('-');\n        if (rangeParts.length < 1 || rangeParts.length > 2) {\n          throw new protocol_js_1.InvalidArgumentException(`Invalid page range: ${range} is not a valid integer range.`);\n        }\n        if (rangeParts.length === 1) {\n          void parseInteger(rangeParts[0] ?? '');\n          continue;\n        }\n        let lowerBound;\n        let upperBound;\n        const [rangeLowerPart = '', rangeUpperPart = ''] = rangeParts;\n        if (rangeLowerPart === '') {\n          lowerBound = 1;\n        } else {\n          lowerBound = parseInteger(rangeLowerPart);\n        }\n        if (rangeUpperPart === '') {\n          upperBound = Number.MAX_SAFE_INTEGER;\n        } else {\n          upperBound = parseInteger(rangeUpperPart);\n        }\n        if (lowerBound > upperBound) {\n          throw new protocol_js_1.InvalidArgumentException(`Invalid page range: ${rangeLowerPart} > ${rangeUpperPart}`);\n        }\n      }\n      cdpParams.pageRanges = params.pageRanges.join(',');\n    }\n    if (params.scale !== undefined) {\n      cdpParams.scale = params.scale;\n    }\n    if (params.shrinkToFit !== undefined) {\n      cdpParams.preferCSSPageSize = !params.shrinkToFit;\n    }\n    try {\n      const result = await this.#cdpTarget.cdpClient.sendCommand('Page.printToPDF', cdpParams);\n      return {\n        data: result.data\n      };\n    } catch (error) {\n      // Effectively zero dimensions.\n      if (error.message === 'invalid print parameters: content area is empty') {\n        throw new protocol_js_1.UnsupportedOperationException(error.message);\n      }\n      throw error;\n    }\n  }\n  /**\n   * See\n   * https://w3c.github.io/webdriver-bidi/#:~:text=If%20command%20parameters%20contains%20%22clip%22%3A\n   */\n  async #parseRect(clip) {\n    switch (clip.type) {\n      case 'box':\n        return {\n          x: clip.x,\n          y: clip.y,\n          width: clip.width,\n          height: clip.height\n        };\n      case 'element':\n        {\n          // TODO: #1213: Use custom sandbox specifically for Chromium BiDi\n          const sandbox = await this.getOrCreateSandbox(undefined);\n          const result = await sandbox.callFunction(String(element => {\n            return element instanceof Element;\n          }), {\n            type: 'undefined'\n          }, [clip.element], false, \"none\" /* Script.ResultOwnership.None */, {});\n          if (result.type === 'exception') {\n            throw new protocol_js_1.NoSuchElementException(`Element '${clip.element.sharedId}' was not found`);\n          }\n          (0, assert_js_1.assert)(result.result.type === 'boolean');\n          if (!result.result.value) {\n            throw new protocol_js_1.NoSuchElementException(`Node '${clip.element.sharedId}' is not an Element`);\n          }\n          {\n            const result = await sandbox.callFunction(String(element => {\n              const rect = element.getBoundingClientRect();\n              return {\n                x: rect.x,\n                y: rect.y,\n                height: rect.height,\n                width: rect.width\n              };\n            }), {\n              type: 'undefined'\n            }, [clip.element], false, \"none\" /* Script.ResultOwnership.None */, {});\n            (0, assert_js_1.assert)(result.type === 'success');\n            const rect = deserializeDOMRect(result.result);\n            if (!rect) {\n              throw new protocol_js_1.UnableToCaptureScreenException(`Could not get bounding box for Element '${clip.element.sharedId}'`);\n            }\n            return rect;\n          }\n        }\n    }\n  }\n  async close() {\n    await this.#cdpTarget.cdpClient.sendCommand('Page.close');\n  }\n  async traverseHistory(delta) {\n    if (delta === 0) {\n      return;\n    }\n    const history = await this.#cdpTarget.cdpClient.sendCommand('Page.getNavigationHistory');\n    const entry = history.entries[history.currentIndex + delta];\n    if (!entry) {\n      throw new protocol_js_1.NoSuchHistoryEntryException(`No history entry at delta ${delta}`);\n    }\n    await this.#cdpTarget.cdpClient.sendCommand('Page.navigateToHistoryEntry', {\n      entryId: entry.id\n    });\n  }\n  async toggleModulesIfNeeded() {\n    const enableNetwork = this.#eventManager.subscriptionManager.isSubscribedToModule(chromium_bidi_js_1.BiDiModule.Network, this.id);\n    await this.#cdpTarget.toggleNetworkIfNeeded(enableNetwork);\n  }\n}\nexports.BrowsingContextImpl = BrowsingContextImpl;\nfunction serializeOrigin(origin) {\n  // https://html.spec.whatwg.org/multipage/origin.html#ascii-serialisation-of-an-origin\n  if (['://', ''].includes(origin)) {\n    origin = 'null';\n  }\n  return origin;\n}\nexports.serializeOrigin = serializeOrigin;\nfunction getImageFormatParameters(params) {\n  const {\n    quality,\n    type\n  } = params.format ?? {\n    type: 'image/png'\n  };\n  switch (type) {\n    case 'image/png':\n      {\n        return {\n          format: 'png'\n        };\n      }\n    case 'image/jpeg':\n      {\n        return {\n          format: 'jpeg',\n          ...(quality === undefined ? {} : {\n            quality: Math.round(quality * 100)\n          })\n        };\n      }\n    case 'image/webp':\n      {\n        return {\n          format: 'webp',\n          ...(quality === undefined ? {} : {\n            quality: Math.round(quality * 100)\n          })\n        };\n      }\n  }\n  throw new protocol_js_1.InvalidArgumentException(`Image format '${type}' is not a supported format`);\n}\nfunction deserializeDOMRect(result) {\n  if (result.type !== 'object' || result.value === undefined) {\n    return;\n  }\n  const x = result.value.find(([key]) => {\n    return key === 'x';\n  })?.[1];\n  const y = result.value.find(([key]) => {\n    return key === 'y';\n  })?.[1];\n  const height = result.value.find(([key]) => {\n    return key === 'height';\n  })?.[1];\n  const width = result.value.find(([key]) => {\n    return key === 'width';\n  })?.[1];\n  if (x?.type !== 'number' || y?.type !== 'number' || height?.type !== 'number' || width?.type !== 'number') {\n    return;\n  }\n  return {\n    x: x.value,\n    y: y.value,\n    width: width.value,\n    height: height.value\n  };\n}\n/** @see https://w3c.github.io/webdriver-bidi/#normalize-rect */\nfunction normalizeRect(box) {\n  return {\n    ...(box.width < 0 ? {\n      x: box.x + box.width,\n      width: -box.width\n    } : {\n      x: box.x,\n      width: box.width\n    }),\n    ...(box.height < 0 ? {\n      y: box.y + box.height,\n      height: -box.height\n    } : {\n      y: box.y,\n      height: box.height\n    })\n  };\n}\n/** @see https://w3c.github.io/webdriver-bidi/#rectangle-intersection */\nfunction getIntersectionRect(first, second) {\n  first = normalizeRect(first);\n  second = normalizeRect(second);\n  const x = Math.max(first.x, second.x);\n  const y = Math.max(first.y, second.y);\n  return {\n    x,\n    y,\n    width: Math.max(Math.min(first.x + first.width, second.x + second.width) - x, 0),\n    height: Math.max(Math.min(first.y + first.height, second.y + second.height) - y, 0)\n  };\n}\nfunction parseInteger(value) {\n  value = value.trim();\n  if (!/^[0-9]+$/.test(value)) {\n    throw new protocol_js_1.InvalidArgumentException(`Invalid integer: ${value}`);\n  }\n  return parseInt(value);\n}","map":{"version":3,"names":["chromium_bidi_js_1","require","protocol_js_1","assert_js_1","Deferred_js_1","log_js_1","unitConversions_js_1","WindowRealm_js_1","BrowsingContextImpl","LOGGER_PREFIX","LogType","debug","id","userContext","parentId","children","Set","browsingContextStorage","lifecycle","DOMContentLoaded","Deferred","load","navigation","withinDocument","url","eventManager","realmStorage","loaderId","cdpTarget","maybeDefaultRealm","sharedIdWithFrame","logger","constructor","create","context","initListeners","addContext","isTopLevelContext","parent","addChild","registerEvent","type","method","ChromiumBidi","BrowsingContext","EventNames","ContextCreated","params","serializeToBidiValue","getTimestamp","Date","getTime","navigableId","dispose","deleteAllChildren","deleteRealms","browsingContextId","delete","failLifecycleIfNotFinished","ContextDestroyed","deleteContextById","getContext","directChildren","map","allChildren","concat","child","top","topContext","childId","add","#deleteAllChildren","defaultRealm","#defaultRealm","assert","updateCdpTarget","lifecycleLoaded","targetUnblockedOrThrow","result","unblocked","kind","error","getOrCreateSandbox","sandbox","undefined","maybeSandboxes","findRealms","length","cdpClient","sendCommand","frameId","worldName","maxDepth","addParentField","c","onTargetInfoChanged","targetInfo","#initListeners","on","frame","urlFragment","timestamp","resolve","FragmentNavigated","NavigationStarted","name","documentChanged","DomContentLoaded","Load","auxData","uniqueId","origin","serializeOrigin","realm","WindowRealm","isDefault","Promise","all","getChannels","channel","startListenerFromWindow","cdpSessionId","executionContextId","accepted","UserPromptClosed","userText","userInput","UserPromptOpened","message","defaultValue","defaultPrompt","#documentChanged","isFinished","resetLifecycleIfFinished","#resetLifecycleIfFinished","#failLifecycleIfNotFinished","reject","UnknownErrorException","navigate","wait","URL","InvalidArgumentException","cdpNavigateResult","errorText","reload","ignoreCache","setViewport","viewport","devicePixelRatio","width","height","deviceScaleFactor","mobile","dontSetVisibleSize","err","startsWith","UnsupportedOperationException","handleUserPrompt","accept","promptText","activate","captureScreenshot","formatParameters","getImageFormatParameters","captureBeyondViewport","script","String","element","document","documentElement","x","y","scrollWidth","scrollHeight","window","visualViewport","pageLeft","pageTop","originResult","callFunction","deserializeDOMRect","rect","clip","getIntersectionRect","parseRect","UnableToCaptureScreenException","scale","print","cdpParams","background","printBackground","margin","bottom","marginBottom","inchesFromCm","left","marginLeft","right","marginRight","marginTop","orientation","landscape","page","paperHeight","paperWidth","pageRanges","range","rangeParts","split","parseInteger","lowerBound","upperBound","rangeLowerPart","rangeUpperPart","Number","MAX_SAFE_INTEGER","join","shrinkToFit","preferCSSPageSize","data","#parseRect","Element","NoSuchElementException","sharedId","value","getBoundingClientRect","close","traverseHistory","delta","history","entry","entries","currentIndex","NoSuchHistoryEntryException","entryId","toggleModulesIfNeeded","enableNetwork","subscriptionManager","isSubscribedToModule","BiDiModule","Network","toggleNetworkIfNeeded","exports","includes","quality","format","Math","round","find","key","normalizeRect","box","first","second","max","min","trim","test","parseInt"],"sources":["../../../../../src/bidiMapper/domains/context/BrowsingContextImpl.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}